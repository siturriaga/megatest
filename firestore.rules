rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // AUTH HELPERS (Custom Claims - FAST)
    // ============================================
    
    function isSignedIn() {
      return request.auth != null;
    }

    // Custom claims from Firebase Auth token (set via Cloud Functions)
    function role() {
      return request.auth.token.role; // 'superadmin' | 'admin' | 'teacher' | 'monitor' | 'kiosk'
    }

    function claimSchool() {
      return request.auth.token.school_id; // e.g., 'SCHOOL123'
    }

    // SuperAdmin bypasses domain restriction
    function isSuperAdmin() {
      return isSignedIn() && role() == 'superadmin';
    }

    // Domain restriction (except SuperAdmin)
    function domainAllowed() {
      return isSignedIn() && (
        request.auth.token.email.matches('.*@dadeschools[.]net$') ||
        request.auth.token.email == 'synapsecopilot@gmail.com'
      );
    }

    // Trusted = SuperAdmin OR on allowed domain
    function isTrustedUser() {
      return isSuperAdmin() || domainAllowed();
    }

    function isAdmin() {
      return isTrustedUser() && (role() == 'admin' || isSuperAdmin());
    }

    function isTeacher() {
      return isTrustedUser() && (role() in ['teacher', 'admin'] || isSuperAdmin());
    }

    function isMonitor() {
      return isTrustedUser() && (role() in ['monitor', 'teacher', 'admin'] || isSuperAdmin());
    }

    function canAccessSchool(schoolId) {
      return isSuperAdmin() || (isTrustedUser() && claimSchool() == schoolId);
    }

    // ============================================
    // VALIDATION HELPERS
    // ============================================
    
    function isValidString(field, minLen, maxLen) {
      return field is string && field.size() >= minLen && field.size() <= maxLen;
    }
    
    function isValidEmail(email) {
      return email is string && email.matches('.*@.*[.].*');
    }
    
    function isValidGrade(grade) {
      return grade is int && grade >= 1 && grade <= 12;
    }
    
    function isValidStatus(status) {
      return status in ['IN', 'OUT'];
    }
    
    function isValidLogType(type) {
      return type in ['PASS', 'RETURN', 'INFRACTION', 'INCENTIVE', 'TARDY'];
    }
    
    function isValidPriority(priority) {
      return priority in ['normal', 'important', 'urgent'];
    }

    // ============================================
    // USERS COLLECTION (Global)
    // ============================================
    
    match /users/{uid} {
      // Read own doc, SuperAdmin reads all, Admin reads same-school users
      allow read: if isTrustedUser() && (
        request.auth.uid == uid || 
        isSuperAdmin() ||
        (isAdmin() && resource.data.school_id == claimSchool())
      );
      
      // Create own doc on first login (must be on allowed domain)
      allow create: if isSignedIn() && 
                       request.auth.uid == uid && 
                       domainAllowed() &&
                       isValidEmail(request.resource.data.email) &&
                       request.resource.data.email == request.auth.token.email;
      
      // Update own doc (except role/email)
      allow update: if isTrustedUser() && 
                       request.auth.uid == uid &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'email']);
      
      // SuperAdmin can update anyone; Admin can promote within school (not to superadmin)
      allow update: if isSuperAdmin() ||
                       (isAdmin() && 
                        resource.data.school_id == claimSchool() &&
                        request.resource.data.role != 'superadmin');
      
      allow delete: if false;
    }

    // ============================================
    // SCHOOLS COLLECTION (Tenant Root)
    // ============================================
    
    match /schools/{schoolId} {
      allow read: if canAccessSchool(schoolId);
      allow create, delete: if isSuperAdmin();
      allow update: if isAdmin() && canAccessSchool(schoolId);

      // ----------------------------------------
      // STUDENTS
      // ----------------------------------------
      match /students/{studentId} {
        allow read: if canAccessSchool(schoolId);
        allow create, delete: if isAdmin() && canAccessSchool(schoolId);
        allow update: if isTeacher() && canAccessSchool(schoolId);
      }

      // ----------------------------------------
      // ACTIVE PASSES
      // ----------------------------------------
      match /active_passes/{passId} {
        allow read: if canAccessSchool(schoolId);
        allow create, update: if isTeacher() && canAccessSchool(schoolId);
        allow delete: if isTeacher() && canAccessSchool(schoolId); // Return = delete
      }

      // ----------------------------------------
      // LOGS (Immutable Audit Trail)
      // ----------------------------------------
      match /logs/{logId} {
        allow read: if canAccessSchool(schoolId);
        allow create: if isTeacher() && canAccessSchool(schoolId) &&
                         isValidLogType(request.resource.data.type);
        allow update: if false; // Immutable
        allow delete: if isSuperAdmin(); // Emergency only
      }

      // ----------------------------------------
      // HOUSES
      // ----------------------------------------
      match /houses/{houseId} {
        allow read: if canAccessSchool(schoolId);
        allow create, delete: if isAdmin() && canAccessSchool(schoolId);
        // Teachers can only update score field
        allow update: if isTeacher() && canAccessSchool(schoolId) &&
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['score']);
        // Admins can update anything
        allow update: if isAdmin() && canAccessSchool(schoolId);
      }

      // ----------------------------------------
      // CONFLICT GROUPS
      // ----------------------------------------
      match /conflictGroups/{groupId} {
        allow read: if canAccessSchool(schoolId);
        allow write: if isAdmin() && canAccessSchool(schoolId);
      }

      // ----------------------------------------
      // SCHOOL CONFIGS
      // ----------------------------------------
      match /school_configs/{configId} {
        allow read: if canAccessSchool(schoolId);
        allow write: if isAdmin() && canAccessSchool(schoolId);
      }

      // ----------------------------------------
      // BOX QUEUE (Approval Requests)
      // ----------------------------------------
      match /box_queue/{itemId} {
        allow read: if isAdmin() && canAccessSchool(schoolId);
        allow create: if isTeacher() && canAccessSchool(schoolId);
        allow update, delete: if isAdmin() && canAccessSchool(schoolId);
      }

      // ----------------------------------------
      // WAITLIST
      // ----------------------------------------
      match /waitlist/{itemId} {
        allow read: if canAccessSchool(schoolId);
        allow write: if isTeacher() && canAccessSchool(schoolId);
      }

      // ----------------------------------------
      // BROADCASTS
      // ----------------------------------------
      match /broadcasts/{broadcastId} {
        allow read: if canAccessSchool(schoolId);
        allow create: if isAdmin() && canAccessSchool(schoolId) &&
                         isValidPriority(request.resource.data.priority);
        allow update, delete: if isAdmin() && canAccessSchool(schoolId);
      }

      // ----------------------------------------
      // PARENT CONTACTS (Immutable)
      // ----------------------------------------
      match /parentContacts/{contactId} {
        allow read: if canAccessSchool(schoolId);
        allow create: if isTeacher() && canAccessSchool(schoolId);
        allow update, delete: if false; // Immutable audit trail
      }
    }

    // ============================================
    // OPTIONAL GLOBAL COLLECTIONS
    // ============================================
    
    match /consent_logs/{id} {
      allow create: if isTrustedUser();
      allow read, update, delete: if false;
    }

    match /wellness_logs/{id} {
      allow create: if isTeacher();
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    match /sub_codes/{id} {
      allow read: if isTrustedUser();
      allow write: if isSuperAdmin();
    }
  }
}
